pipeline {
    agent any
    
    // GitLab í”ŒëŸ¬ê·¸ì¸ íŠ¸ë¦¬ê±° ì„¤ì •
    triggers {
        gitlab(
            triggerOnPush: true,
            triggerOnMergeRequest: true,
            branchFilterType: 'All'
        )
    }

    environment {
        // ê³µí†µ í™˜ê²½ ë³€ìˆ˜
        GCP_DEPLOY_HOST = "rublin322@picscore.net"
        GCP_DEPLOY_PATH = "/home/rublin322/lumina"
        AWS_DEPLOY_HOST = "ubuntu@k12s306.p.ssafy.io"
        AWS_DEPLOY_PATH = "/home/ubuntu/lumina"
        
        // í™˜ê²½ ë³€ìˆ˜
        ENVIRONMENT = 'ê°œë°œ'
        
        // Jenkins ë¹Œë“œ URL
        BUILD_URL = "${env.JENKINS_URL}job/lumina/job/${env.BRANCH_NAME}/${env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    echo "í˜„ì¬ ë¸Œëœì¹˜: ${env.BRANCH_NAME}"
                    echo "í˜„ì¬ ì›Œí¬ìŠ¤í˜ì´ìŠ¤: ${env.WORKSPACE}"
                    
                    // í™˜ê²½ ì„¤ì •
                    if (env.BRANCH_NAME == 'master') {
                        env.ENVIRONMENT = 'ìš´ì˜'
                    }
                }
            }
        }
        
        stage('SonarQube Analysis') {
            parallel {
                stage('Backend Analysis') {
                    when {
                        branch 'develop'
                    }
                    steps {
                        withSonarQubeEnv('SonarQube') {
                            dir('backend') {
                                sh 'chmod +x ./gradlew' 
                                sh './gradlew sonar -x test'
                            }
                        }
                        // Quality Gate í™•ì¸
                        timeout(time: 3, unit: 'MINUTES') {
                            waitForQualityGate abortPipeline: false
                        }
                    }
                }
                
                stage('Frontend Analysis') {
                    when {
                        branch 'develop'
                    }
                    steps {
                        nodejs('Node22') {
                            withSonarQubeEnv('SonarQube') {
                                dir('frontend') {
                                    // Yarn ì˜ì¡´ì„± ì„¤ì¹˜
                                    sh 'yarn install'
                                    // SonarScanner ì‹¤í–‰ (package.jsonì— ì´ë¯¸ ì„¤ì •ëœ sonar ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©)
                                    sh 'yarn sonar'
                                }
                            }
                            // Quality Gate í™•ì¸
                            timeout(time: 3, unit: 'MINUTES') {
                                waitForQualityGate abortPipeline: false
                            }
                        }
                    }
                }
            }
        }

        stage('Prepare Environment') {
            parallel {
                stage('Dev Environment') {
                    when {
                        anyOf {
                            branch 'develop'
                            branch 'backend'
                            branch 'frontend'
                        }
                    }
                    steps {
                        withCredentials([file(credentialsId: 'env-dev-content', variable: 'ENV_DEV_PATH')]) {
                            script {
                                def envContent = readFile(ENV_DEV_PATH)
                                writeFile file: 'infra/dev/.env', text: envContent
                            }
                        }
                        withCredentials([file(credentialsId: 'env-front-dev-content', variable: 'ENV_FRONT_DEV_PATH')]) {
                            script {
                                def envFrontContent = readFile(ENV_FRONT_DEV_PATH)
                                writeFile file: 'infra/dev/.env.front', text: envFrontContent
                            }
                        }
                        withCredentials([file(credentialsId: 'htpasswd-dev-content', variable: "HTPASSWD_DEV_PATH")]) {
                            script {
                                def htpasswdContent = readFile(HTPASSWD_DEV_PATH)
                                writeFile file: 'infra/dev/proxy/.htpasswd', text: htpasswdContent
                            }
                        }
                        withCredentials([file(credentialsId: 'ga-service-account-dev', variable: "GA_SERVICE_ACCOUNT_DEV_PATH")]) {
                            script {
                                def gaServiceAccountContent = readFile(GA_SERVICE_ACCOUNT_DEV_PATH)
                                writeFile file: 'infra/dev/monitoring/grafana/secrets/ga-service-account.json', text: gaServiceAccountContent
                            }
                        }
                    }
                }
                
                stage('Prod Environment') {
                    when {
                        branch 'master'
                    }
                    steps {
                        withCredentials([file(credentialsId: 'env-prod-content', variable: 'ENV_PROD_PATH')]) {
                            script {
                                def envContent = readFile(ENV_PROD_PATH)
                                writeFile file: 'infra/prod/.env', text: envContent
                            }
                        }
                        withCredentials([file(credentialsId: 'env-front-prod-content', variable: 'ENV_FRONT_PROD_PATH')]) {
                            script {
                                def envFrontContent = readFile(ENV_FRONT_PROD_PATH)
                                writeFile file: 'infra/prod/.env.front', text: envFrontContent
                            }
                        }
                        withCredentials([file(credentialsId: 'htpasswd-prod-content', variable: "HTPASSWD_PROD_PATH")]) {
                            script {
                                def htpasswdContent = readFile(HTPASSWD_PROD_PATH)
                                writeFile file: 'infra/prod/proxy/.htpasswd', text: htpasswdContent
                            }
                        }
                        withCredentials([file(credentialsId: 'ga-service-account-prod', variable: "GA_SERVICE_ACCOUNT_PROD_PATH")]) {
                            script {
                                def gaServiceAccountContent = readFile(GA_SERVICE_ACCOUNT_PROD_PATH)
                                writeFile file: 'infra/prod/monitoring/grafana/secrets/ga-service-account.json', text: gaServiceAccountContent
                            }
                        }
                    }
                }
            }
        }

        stage('Build and Deploy') {
            parallel {
                stage('Develop Branch') {
                    when {
                        anyOf {
                            branch 'develop'
                            branch 'frontend'
                            branch 'backend'
                        }
                    }
                    stages {
                        stage('Build Docker Images - Dev') {
                            steps {
                                script {
                                    // í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ (frontend ë¸Œëœì¹˜ ë˜ëŠ” develop ë¸Œëœì¹˜ì¸ ê²½ìš°)
                                    if (env.BRANCH_NAME == 'frontend' || env.BRANCH_NAME == 'develop') {
                                        dir('frontend') {
                                            sh "cp ../infra/dev/.env.front .env.front"
                                            sh "docker build -t rublin322/lumina-frontend:develop ."
                                        }
                                    }
                                    
                                    // ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ (backend ë¸Œëœì¹˜ ë˜ëŠ” develop ë¸Œëœì¹˜ì¸ ê²½ìš°)
                                    if (env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'develop') {
                                        dir('backend') {
                                            sh "docker build -t rublin322/lumina-backend:develop ."
                                        }
                                    }

                                    // AI ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ (backend ë¸Œëœì¹˜ ë˜ëŠ” develop ë¸Œëœì¹˜ì¸ ê²½ìš°)
                                    if (env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'develop') {
                                        dir('ai') {
                                            sh "docker build -t rublin322/lumina-ai:develop ."
                                        }
                                    }
                                }
                            }
                        }
                        
                        stage('Push to DockerHub - Dev') {
                            steps {
                                withDockerRegistry([credentialsId: 'dockerhub-token', url: '']) {
                                    script {
                                        // í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ í‘¸ì‹œ (frontend ë¸Œëœì¹˜ ë˜ëŠ” develop ë¸Œëœì¹˜ì¸ ê²½ìš°)
                                        if (env.BRANCH_NAME == 'frontend' || env.BRANCH_NAME == 'develop') {
                                            sh "docker push rublin322/lumina-frontend:develop"
                                        }
                                        
                                        // ë°±ì—”ë“œ ì´ë¯¸ì§€ í‘¸ì‹œ (backend ë¸Œëœì¹˜ ë˜ëŠ” develop ë¸Œëœì¹˜ì¸ ê²½ìš°)
                                        if (env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'develop') {
                                            sh "docker push rublin322/lumina-backend:develop"
                                        }

                                        // AI ì„œë²„ ì´ë¯¸ì§€ í‘¸ì‹œ (backend ë¸Œëœì¹˜ ë˜ëŠ” develop ë¸Œëœì¹˜ì¸ ê²½ìš°)
                                        if (env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'develop') {
                                            sh "docker push rublin322/lumina-ai:develop"
                                        }
                                    }
                                }
                            }
                        }
                        
                        stage('Deploy to GCP - Dev') {
                            steps {
                                sshagent(credentials: ['gcp-ssh-key']) {
                                    // ë””ë ‰í† ë¦¬ ìƒì„±
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/proxy'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/proxy/blue-green/frontend'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/proxy/blue-green/backend'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/proxy/blue-green/ai-server'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/monitoring/prometheus'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/monitoring/grafana'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/monitoring/grafana/secrets'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/scripts'"
                                    
                                    // í™˜ê²½ ì„¤ì • íŒŒì¼ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/.env ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/.env"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/.env.front ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/.env.front"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/docker-compose.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/docker-compose.yml"

                                    // Google Analytics ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/monitoring/grafana/secrets/ga-service-account.json ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/monitoring/grafana/secrets/ga-service-account.json"
                                    
                                    // í”„ë¡ì‹œ ì„¤ì • íŒŒì¼ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/.htpasswd ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/.htpasswd"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/nginx.conf ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/nginx.conf"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/proxy-compose.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/proxy-compose.yml"
                                    
                                    // Blue-Green ì„¤ì • íŒŒì¼ ì „ì†¡ - location.confë§Œ ì „ì†¡ (upstream.confëŠ” ì„œë²„ì—ì„œ ê´€ë¦¬)
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/blue-green/frontend/location.conf ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/blue-green/frontend/location.conf"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/blue-green/backend/location.conf ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/blue-green/backend/location.conf"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/blue-green/ai-server/location.conf ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/blue-green/ai-server/location.conf"
                                    
                                    // upstream.conf ì´ˆê¸°í™” íŒŒì¼ ì²´í¬ - ì´ˆê¸° ë°°í¬ì‹œ activeì™€ backup ì„œë²„ ëª¨ë‘ ì„¤ì •
                                    sh """
                                    ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'DEPLOY_PATH="${GCP_DEPLOY_PATH}" && 
                                    mkdir -p "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/frontend" && 
                                    mkdir -p "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/backend" && 
                                    mkdir -p "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/ai-server" && 
                                    if [ ! -f "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/frontend/upstream.conf" ]; then 
                                        echo -e "upstream frontend {\\n    server frontend-blue:80;    # active\\n    server frontend-green:80 backup;    # backup\\n}" > "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/frontend/upstream.conf"; 
                                    fi && 
                                    if [ ! -f "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/backend/upstream.conf" ]; then 
                                        echo -e "upstream backend {\\n    server backend-blue:8080;    # active\\n    server backend-green:8080 backup;    # backup\\n}" > "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/backend/upstream.conf"; 
                                    fi && 
                                    if [ ! -f "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/ai-server/upstream.conf" ]; then 
                                        echo -e "upstream ai-server {\\n    server ai-server-blue:8000;    # active\\n    server ai-server-green:8000 backup;    # backup\\n}" > "\${DEPLOY_PATH}/infra/dev/proxy/blue-green/ai-server/upstream.conf"; 
                                    fi'
                                    """
                                    
                                    // ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/scripts/blue-green-deploy.sh ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/scripts/blue-green-deploy.sh"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'chmod +x ${GCP_DEPLOY_PATH}/infra/scripts/blue-green-deploy.sh'"
                                    
                                    // ëª¨ë‹ˆí„°ë§ ì„¤ì • íŒŒì¼ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/monitoring/monitoring-compose.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/monitoring/monitoring-compose.yml"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/monitoring/prometheus/prometheus.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/monitoring/prometheus/prometheus.yml"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/monitoring/grafana/datasource.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/monitoring/grafana/datasource.yml"

                                    // ì´ˆê¸° ë°°í¬ ë˜ëŠ” Blue-Green ë°°í¬ ì‹¤í–‰
                                    script {
                                        if (env.BRANCH_NAME == 'frontend') {
                                            // í”„ë¡ íŠ¸ì—”ë“œë§Œ ë°°í¬
                                            sh """
                                            ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} '
                                                cd ${GCP_DEPLOY_PATH} && 
                                                ./infra/scripts/blue-green-deploy.sh dev frontend
                                            '
                                            """
                                        } else if (env.BRANCH_NAME == 'backend') {
                                            // ë°±ì—”ë“œë§Œ ë°°í¬
                                            sh """
                                            ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} '
                                                cd ${GCP_DEPLOY_PATH} && 
                                                ./infra/scripts/blue-green-deploy.sh dev backend
                                            '
                                            """
                                        } else {
                                            // ì „ì²´ ë°°í¬ (develop ë¸Œëœì¹˜)
                                            // docker system prune -af ì¶”ê°€í• ì§€
                                            sh """
                                            ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} '
                                                cd ${GCP_DEPLOY_PATH} &&
                                                ./infra/scripts/blue-green-deploy.sh dev all
                                            '
                                            """
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                stage('Master Branch') {
                    when {
                        branch 'master'
                    }
                    stages {
                        stage('Build Docker Images - Prod') {
                            steps {
                                script {
                                    // í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ
                                    dir('frontend') {
                                        sh "cp ../infra/prod/.env.front .env.front"
                                        sh "docker build -t rublin322/lumina-frontend:latest ."
                                    }
                                    
                                    // ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ
                                    dir('backend') {
                                        sh "docker build -t rublin322/lumina-backend:latest ."
                                    }

                                    // AI ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ
                                    dir('ai') {
                                        sh "docker build -t rublin322/lumina-ai:latest ."
                                    }
                                }
                            }
                        }
                        
                        stage('Push to DockerHub - Prod') {
                            steps {
                                withDockerRegistry([credentialsId: 'dockerhub-token', url: '']) {
                                    sh "docker push rublin322/lumina-frontend:latest"
                                    sh "docker push rublin322/lumina-backend:latest"
                                    sh "docker push rublin322/lumina-ai:latest"
                                }
                            }
                        }
                        
                        stage('Deploy to AWS - Prod') {
                            steps {
                                sshagent(credentials: ['aws-ssh-key']) {
                                    // ë””ë ‰í† ë¦¬ ìƒì„±
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/proxy'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/proxy/blue-green/frontend'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/proxy/blue-green/backend'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/proxy/blue-green/ai-server'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/monitoring/prometheus'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/monitoring/grafana/dashboards'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/monitoring/grafana/secrets'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/scripts'"
                                    
                                    // í™˜ê²½ ì„¤ì • íŒŒì¼ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/.env ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/.env"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/.env.front ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/.env.front"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/docker-compose.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/docker-compose.yml"

                                    // Google Analytics ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/monitoring/grafana/secrets/ga-service-account.json ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/monitoring/grafana/secrets/ga-service-account.json"
                                    
                                    // í”„ë¡ì‹œ ì„¤ì • íŒŒì¼ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/.htpasswd ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/.htpasswd"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/nginx.conf ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/nginx.conf"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/proxy-compose.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/proxy-compose.yml"
                                    
                                    // Blue-Green ì„¤ì • íŒŒì¼ ì „ì†¡ - location.confë§Œ ì „ì†¡ (upstream.confëŠ” ì„œë²„ì—ì„œ ê´€ë¦¬)
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/blue-green/frontend/location.conf ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/blue-green/frontend/location.conf"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/blue-green/backend/location.conf ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/blue-green/backend/location.conf"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/blue-green/ai-server/location.conf ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/blue-green/ai-server/location.conf"
                                    
                                    // upstream.conf ì´ˆê¸°í™” íŒŒì¼ ì²´í¬ - ì´ˆê¸° ë°°í¬ì‹œ activeì™€ backup ì„œë²„ ëª¨ë‘ ì„¤ì •
                                    sh """
                                    ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'DEPLOY_PATH="${AWS_DEPLOY_PATH}" && 
                                    mkdir -p "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/frontend" && 
                                    mkdir -p "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/backend" && 
                                    mkdir -p "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/ai-server" && 
                                    if [ ! -f "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/frontend/upstream.conf" ]; then 
                                        echo -e "upstream frontend {\\n    server frontend-blue:80;    # active\\n    server frontend-green:80 backup;    # backup\\n}" > "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/frontend/upstream.conf"; 
                                    fi && 
                                    if [ ! -f "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/backend/upstream.conf" ]; then 
                                        echo -e "upstream backend {\\n    server backend-blue:8080;    # active\\n    server backend-green:8080 backup;    # backup\\n}" > "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/backend/upstream.conf"; 
                                    fi && 
                                    if [ ! -f "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/ai-server/upstream.conf" ]; then 
                                        echo -e "upstream ai-server {\\n    server ai-server-blue:8000;    # active\\n    server ai-server-green:8000 backup;    # backup\\n}" > "\${DEPLOY_PATH}/infra/prod/proxy/blue-green/ai-server/upstream.conf"; 
                                    fi'
                                    """
                                    
                                    // ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/scripts/blue-green-deploy.sh ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/scripts/blue-green-deploy.sh"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'chmod +x ${AWS_DEPLOY_PATH}/infra/scripts/blue-green-deploy.sh'"
                                    
                                    // ëª¨ë‹ˆí„°ë§ ì„¤ì • íŒŒì¼ ì „ì†¡
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/monitoring/monitoring-compose.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/monitoring/monitoring-compose.yml"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/monitoring/prometheus/prometheus.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/monitoring/prometheus/prometheus.yml"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/monitoring/grafana/datasource.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/monitoring/grafana/datasource.yml"

                                    // ìš´ì˜ í™˜ê²½ ë°°í¬ ì‹¤í–‰ - Blue-Green ë°°í¬
                                    sh """
                                    ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} '
                                        cd ${AWS_DEPLOY_PATH} &&
                                        ./infra/scripts/blue-green-deploy.sh prod all &&
                                        docker system prune -af
                                    '
                                    """
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                def deployEnv = ''
                def deployType = ''
                def deployInfo = ''
                
                if (env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'frontend') {
                    echo 'ê°œë°œ í™˜ê²½ ë°°í¬ ì„±ê³µ'
                    deployEnv = 'ê°œë°œ'
                    deployType = 'GCP'
                    deployInfo = 'ê°œë°œ ì„œë²„ì— ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
                } else if (env.BRANCH_NAME == 'master') {
                    echo 'ìš´ì˜ í™˜ê²½ ë°°í¬ ì„±ê³µ'
                    deployEnv = 'ìš´ì˜'
                    deployType = 'AWS'
                    deployInfo = 'ìš´ì˜ ì„œë²„ì— ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
                }
                if (env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'frontend') {
                    mattermostSend color: 'good', 
                        message: """
âœ… ë°°í¬ ì„±ê³µ: ${env.BRANCH_NAME} #${env.BUILD_NUMBER}
ğŸŒ í™˜ê²½: ${deployEnv} (${deployType})
ğŸ“ ìƒì„¸ ì •ë³´: ${deployInfo}
ğŸ”— ë¹Œë“œ ë§í¬: ${env.BUILD_URL}
""",
                        channel: 's306-alarm',
                        endpoint: 'https://meeting.ssafy.com/hooks/7qa9fbgsbtb3fyak3sao9n887e'
                }
            }
        }
        failure {
            script {
                def deployEnv = ''
                def deployType = ''
                def deployInfo = ''
                
                if (env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'frontend') {
                    echo 'ê°œë°œ í™˜ê²½ ë°°í¬ ì‹¤íŒ¨'
                    deployEnv = 'ê°œë°œ'
                    deployType = 'GCP'
                    deployInfo = 'ê°œë°œ ì„œë²„ì— ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
                } else if (env.BRANCH_NAME == 'master') {
                    echo 'ìš´ì˜ í™˜ê²½ ë°°í¬ ì‹¤íŒ¨'
                    deployEnv = 'ìš´ì˜'
                    deployType = 'AWS'
                    deployInfo = 'ìš´ì˜ ì„œë²„ì— ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
                }
                if (env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'frontend') {
                
                    mattermostSend color: 'danger', 
                        message: """
âŒ ë°°í¬ ì‹¤íŒ¨: ${env.BRANCH_NAME} #${env.BUILD_NUMBER}
ğŸŒ í™˜ê²½: ${deployEnv} (${deployType})
âš ï¸ ìƒì„¸ ì •ë³´: ${deployInfo}
ğŸ”— ë¹Œë“œ ë§í¬: ${env.BUILD_URL}
""",
                        channel: 's306-alarm',
                        endpoint: 'https://meeting.ssafy.com/hooks/7qa9fbgsbtb3fyak3sao9n887e'
                }
            }
        }
        always {
            echo 'ë°°í¬ íŒŒì´í”„ë¼ì¸ ì¢…ë£Œ'
            cleanWs()
        }
    }
}