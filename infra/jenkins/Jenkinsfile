pipeline {
    agent any
    
    // GitLab 플러그인 트리거 설정
    triggers {
        gitlab(
            triggerOnPush: true,
            triggerOnMergeRequest: true,
            branchFilterType: 'All'
        )
    }

    environment {
        // 공통 환경 변수
        GCP_DEPLOY_HOST = "rublin322@picscore.net"
        GCP_DEPLOY_PATH = "/home/rublin322/lumina"
        AWS_DEPLOY_HOST = "ubuntu@k12s306.p.ssafy.io"
        AWS_DEPLOY_PATH = "/home/ubuntu/lumina"
        
        // GitLab 정보 저장 변수
        AUTHOR_NAME = ''
        AUTHOR_EMAIL = ''
        CHANGE_INFO = ''
        ENVIRONMENT = '개발'
        
        // Jenkins 빌드 URL
        BUILD_URL = "${env.JENKINS_URL}job/${env.JOB_NAME}/${env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    echo "현재 브랜치: ${env.BRANCH_NAME}"
                    echo "현재 워크스페이스: ${env.WORKSPACE}"
                    
                    // 환경 설정
                    if (env.BRANCH_NAME == 'master') {
                        env.ENVIRONMENT = '운영'
                    }
                    
                    // GitLab 정보 수집 - 개선된 방식
                    if (env.gitlabActionType) {
                        echo "GitLab 이벤트: ${env.gitlabActionType}"
                        
                        // MR 관련 이벤트인 경우
                        if (env.gitlabMergeRequestIid) {
                            env.AUTHOR_NAME = env.gitlabUserName ?: 'Unknown'
                            env.AUTHOR_EMAIL = env.gitlabUserEmail ?: ''
                            env.CHANGE_INFO = "MR: ${env.gitlabMergeRequestTitle ?: env.gitlabSourceBranch + ' → ' + env.gitlabTargetBranch}"
                        }
                        // 일반 Push 이벤트인 경우
                        else if (env.gitlabBefore && env.gitlabAfter) {
                            env.AUTHOR_NAME = env.gitlabUserName ?: 'Unknown'
                            env.AUTHOR_EMAIL = env.gitlabUserEmail ?: ''
                            env.CHANGE_INFO = "Branch: ${env.gitlabSourceBranch ?: env.BRANCH_NAME}"
                        }
                    }
                    // GitLab 정보가 없는 경우 Git 명령어로 정보 가져오기 (Windows/Linux 호환)
                    else {
                        try {
                            // Windows와 Linux 환경 모두 지원하는 방식
                            if (isUnix()) {
                                env.AUTHOR_NAME = sh(script: 'git log -1 --pretty=%an', returnStdout: true).trim()
                                env.AUTHOR_EMAIL = sh(script: 'git log -1 --pretty=%ae', returnStdout: true).trim()
                                env.CHANGE_INFO = sh(script: 'git log -1 --pretty=%s', returnStdout: true).trim()
                            } else {
                                env.AUTHOR_NAME = bat(script: '@git log -1 --pretty=%an', returnStdout: true).trim()
                                env.AUTHOR_EMAIL = bat(script: '@git log -1 --pretty=%ae', returnStdout: true).trim()
                                env.CHANGE_INFO = bat(script: '@git log -1 --pretty=%s', returnStdout: true).trim()
                            }
                            
                            // 값이 비어있는 경우 기본값 설정
                            if (!env.AUTHOR_NAME || env.AUTHOR_NAME.trim() == '') {
                                env.AUTHOR_NAME = 'Unknown'
                            }
                            if (!env.AUTHOR_EMAIL || env.AUTHOR_EMAIL.trim() == '') {
                                env.AUTHOR_EMAIL = ''
                            }
                            if (!env.CHANGE_INFO || env.CHANGE_INFO.trim() == '') {
                                env.CHANGE_INFO = '코드 변경'
                            }
                        } catch (Exception e) {
                            echo "Git 정보를 가져오는 중 오류 발생: ${e.message}"
                            env.AUTHOR_NAME = 'Unknown'
                            env.AUTHOR_EMAIL = ''
                            env.CHANGE_INFO = '코드 변경'
                        }
                    }
                    
                    echo "작성자: ${env.AUTHOR_NAME} (${env.AUTHOR_EMAIL})"
                    echo "변경사항: ${env.CHANGE_INFO}"
                }
            }
        }
        
        stage('SonarQube Analysis') {
            parallel {
                stage('Backend Analysis') {
                    when {
                        branch 'develop'
                    }
                    steps {
                        withSonarQubeEnv('SonarQube') {
                            dir('backend') {
                                sh 'chmod +x ./gradlew' 
                                sh './gradlew sonar -x test'
                            }
                        }
                        // Quality Gate 확인
                        timeout(time: 3, unit: 'MINUTES') {
                            waitForQualityGate abortPipeline: false
                        }
                    }
                }
                
                stage('Frontend Analysis') {
                    when {
                        branch 'develop'
                    }
                    steps {
                        withSonarQubeEnv('SonarQube') {
                            dir('frontend') {
                                sh 'sonar-scanner -Dsonar.projectKey=lumina-frontend'
                            }
                        }
                        // Quality Gate 확인
                        timeout(time: 3, unit: 'MINUTES') {
                            waitForQualityGate abortPipeline: false
                        }
                    }
                }
            }
        }

        stage('Prepare Environment') {
            parallel {
                stage('Dev Environment') {
                    when {
                        anyOf {
                            branch 'develop'
                            branch 'backend'
                            branch 'frontend'
                        }
                    }
                    steps {
                        withCredentials([file(credentialsId: 'env-dev-content', variable: 'ENV_DEV_PATH')]) {
                            script {
                                def envContent = readFile(ENV_DEV_PATH)
                                writeFile file: 'infra/dev/.env', text: envContent
                            }
                        }
                        withCredentials([file(credentialsId: 'env-front-dev-content', variable: 'ENV_FRONT_DEV_PATH')]) {
                            script {
                                def envFrontContent = readFile(ENV_FRONT_DEV_PATH)
                                writeFile file: 'infra/dev/.env.front', text: envFrontContent
                            }
                        }
                        withCredentials([file(credentialsId: 'htpasswd-dev-content', variable: "HTPASSWD_DEV_PATH")]) {
                            script {
                                def htpasswdContent = readFile(HTPASSWD_DEV_PATH)
                                writeFile file: 'infra/dev/proxy/.htpasswd', text: htpasswdContent
                            }
                        }
                    }
                }
                
                stage('Prod Environment') {
                    when {
                        branch 'master'
                    }
                    steps {
                        withCredentials([file(credentialsId: 'env-prod-content', variable: 'ENV_PROD_PATH')]) {
                            script {
                                def envContent = readFile(ENV_PROD_PATH)
                                writeFile file: 'infra/prod/.env', text: envContent
                            }
                        }
                        withCredentials([file(credentialsId: 'env-front-prod-content', variable: 'ENV_FRONT_PROD_PATH')]) {
                            script {
                                def envFrontContent = readFile(ENV_FRONT_PROD_PATH)
                                writeFile file: 'infra/prod/.env.front', text: envFrontContent
                            }
                        }
                        withCredentials([file(credentialsId: 'htpasswd-prod-content', variable: "HTPASSWD_PROD_PATH")]) {
                            script {
                                def htpasswdContent = readFile(HTPASSWD_PROD_PATH)
                                writeFile file: 'infra/prod/proxy/.htpasswd', text: htpasswdContent
                            }
                        }
                    }
                }
            }
        }

        stage('Build and Deploy') {
            parallel {
                stage('Develop Branch') {
                    when {
                        anyOf {
                            branch 'develop'
                            branch 'frontend'
                            branch 'backend'
                        }
                    }
                    stages {
                        stage('Build Docker Images - Dev') {
                            steps {
                                script {
                                    // 프론트엔드 이미지 빌드 (frontend 브랜치 또는 develop 브랜치인 경우)
                                    if (env.BRANCH_NAME == 'frontend' || env.BRANCH_NAME == 'develop') {
                                        dir('frontend') {
                                            sh "cp ../infra/dev/.env.front .env.front"
                                            sh "docker build -t rublin322/lumina-frontend:develop ."
                                        }
                                    }
                                    
                                    // 백엔드 이미지 빌드 (backend 브랜치 또는 develop 브랜치인 경우)
                                    if (env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'develop') {
                                        dir('backend') {
                                            sh "docker build -t rublin322/lumina-backend:develop ."
                                        }
                                    }
                                }
                            }
                        }
                        
                        stage('Push to DockerHub - Dev') {
                            steps {
                                withDockerRegistry([credentialsId: 'dockerhub-token', url: '']) {
                                    script {
                                        // 프론트엔드 이미지 푸시 (frontend 브랜치 또는 develop 브랜치인 경우)
                                        if (env.BRANCH_NAME == 'frontend' || env.BRANCH_NAME == 'develop') {
                                            sh "docker push rublin322/lumina-frontend:develop"
                                        }
                                        
                                        // 백엔드 이미지 푸시 (backend 브랜치 또는 develop 브랜치인 경우)
                                        if (env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'develop') {
                                            sh "docker push rublin322/lumina-backend:develop"
                                        }
                                    }
                                }
                            }
                        }
                        
                        stage('Deploy to GCP - Dev') {
                            steps {
                                sshagent(credentials: ['gcp-ssh-key']) {
                                    // 환경 설정 파일 전송
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/proxy'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/monitoring/prometheus'"
                                    sh "ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} 'mkdir -p ${GCP_DEPLOY_PATH}/infra/dev/monitoring/grafana'"
                                    
                                    // 환경 설정 파일 전송
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/.env ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/.env"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/.env.front ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/.env.front"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/docker-compose.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/docker-compose.yml"
                                    
                                    // 프록시 설정 배포
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/.htpasswd ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/.htpasswd"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/nginx.conf ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/nginx.conf"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/proxy/proxy-compose.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/proxy/proxy-compose.yml"
                                    
                                    // 모니터링 파일 배포
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/monitoring/monitoring-compose.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/monitoring/monitoring-compose.yml"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/monitoring/prometheus/prometheus.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/monitoring/prometheus/prometheus.yml"
                                    sh "scp -o StrictHostKeyChecking=no infra/dev/monitoring/grafana/datasource.yml ${GCP_DEPLOY_HOST}:${GCP_DEPLOY_PATH}/infra/dev/monitoring/grafana/datasource.yml"

                                    // 개발 환경 배포 실행
                                    sh """
                                    ssh -o StrictHostKeyChecking=no ${GCP_DEPLOY_HOST} '
                                        cd ${GCP_DEPLOY_PATH}/infra/dev &&
                                        docker compose down --remove-orphans &&
                                        docker compose pull &&
                                        docker compose up -d &&
                                        cd ${GCP_DEPLOY_PATH}/infra/dev/proxy &&
                                        docker compose -f proxy-compose.yml -p proxy down --remove-orphans &&
                                        docker compose -f proxy-compose.yml -p proxy pull &&
                                        docker compose -f proxy-compose.yml -p proxy up -d &&
                                        cd ${GCP_DEPLOY_PATH}/infra/dev/monitoring &&
                                        docker compose -f monitoring-compose.yml -p monitoring down --remove-orphans &&
                                        docker compose -f monitoring-compose.yml -p monitoring pull &&
                                        docker compose -f monitoring-compose.yml -p monitoring up -d &&
                                        docker system prune -af
                                    '
                                    """
                                }
                            }
                        }
                    }
                }
                
                stage('Master Branch') {
                    when {
                        branch 'master'
                    }
                    stages {
                        stage('Build Docker Images - Prod') {
                            steps {
                                script {
                                    // 프론트엔드 이미지 빌드
                                    dir('frontend') {
                                        sh "cp ../infra/prod/.env.front .env.front"
                                        sh "docker build -t rublin322/lumina-frontend:latest ."
                                    }
                                    
                                    // 백엔드 이미지 빌드
                                    dir('backend') {
                                        sh "docker build -t rublin322/lumina-backend:latest ."
                                    }
                                }
                            }
                        }
                        
                        stage('Push to DockerHub - Prod') {
                            steps {
                                withDockerRegistry([credentialsId: 'dockerhub-token', url: '']) {
                                    sh "docker push rublin322/lumina-frontend:latest"
                                    sh "docker push rublin322/lumina-backend:latest"
                                }
                            }
                        }
                        
                        stage('Deploy to AWS - Prod') {
                            steps {
                                sshagent(credentials: ['aws-ssh-key']) {
                                    // 디렉토리 생성
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/proxy'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/monitoring/prometheus'"
                                    sh "ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} 'mkdir -p ${AWS_DEPLOY_PATH}/infra/prod/monitoring/grafana/dashboards'"
                                    
                                    // 환경 설정 파일 전송
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/.env ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/.env"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/.env.front ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/.env.front"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/docker-compose.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/docker-compose.yml"
                                    
                                    // 프록시 설정 배포
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/.htpasswd ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/.htpasswd"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/nginx.conf ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/nginx.conf"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/proxy/proxy-compose.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/proxy/proxy-compose.yml"
                                    
                                    // 모니터링 파일 배포
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/monitoring/monitoring-compose.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/monitoring/monitoring-compose.yml"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/monitoring/prometheus/prometheus.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/monitoring/prometheus/prometheus.yml"
                                    sh "scp -o StrictHostKeyChecking=no infra/prod/monitoring/grafana/datasource.yml ${AWS_DEPLOY_HOST}:${AWS_DEPLOY_PATH}/infra/prod/monitoring/grafana/datasource.yml"

                                    // 운영 환경 배포 실행
                                    sh """
                                    ssh -o StrictHostKeyChecking=no ${AWS_DEPLOY_HOST} '
                                        cd ${AWS_DEPLOY_PATH}/infra/prod &&
                                        docker compose down --remove-orphans &&
                                        docker compose pull &&
                                        docker compose up -d &&
                                        cd ${AWS_DEPLOY_PATH}/infra/prod/proxy &&
                                        docker compose -f proxy-compose.yml -p proxy down --remove-orphans &&
                                        docker compose -f proxy-compose.yml -p proxy pull &&
                                        docker compose -f proxy-compose.yml -p proxy up -d &&
                                        cd ${AWS_DEPLOY_PATH}/infra/prod/monitoring &&
                                        docker compose -f monitoring-compose.yml -p monitoring down --remove-orphans &&
                                        docker compose -f monitoring-compose.yml -p monitoring pull &&
                                        docker compose -f monitoring-compose.yml -p monitoring up -d &&
                                        docker system prune -af
                                    '
                                    """
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                def deployEnv = ''
                def deployType = ''
                def deployInfo = ''
                
                if (env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'frontend') {
                    echo '개발 환경 배포 성공'
                    deployEnv = '개발'
                    deployType = 'GCP'
                    deployInfo = '개발 서버에 배포가 완료되었습니다.'
                } else if (env.BRANCH_NAME == 'master') {
                    echo '운영 환경 배포 성공'
                    deployEnv = '운영'
                    deployType = 'AWS'
                    deployInfo = '운영 서버에 배포가 완료되었습니다.'
                }
                
                mattermostSend color: 'good', 
                    message: """
✅ 배포 성공: ${env.BRANCH_NAME} #${env.BUILD_NUMBER}
👤 작성자: ${env.AUTHOR_NAME} ${env.AUTHOR_EMAIL ? '(' + env.AUTHOR_EMAIL + ')' : ''}
🌐 환경: ${deployEnv} (${deployType})
📝 상세 정보: ${deployInfo}
🔗 빌드 링크: ${env.BUILD_URL}
""",
                    channel: 's306-alarm',
                    endpoint: 'https://meeting.ssafy.com/hooks/7qa9fbgsbtb3fyak3sao9n887e'
            }
        }
        failure {
            script {
                def deployEnv = ''
                def deployType = ''
                def deployInfo = ''
                
                if (env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'backend' || env.BRANCH_NAME == 'frontend') {
                    echo '개발 환경 배포 실패'
                    deployEnv = '개발'
                    deployType = 'GCP'
                    deployInfo = '개발 서버에 배포가 실패했습니다.'
                } else if (env.BRANCH_NAME == 'master') {
                    echo '운영 환경 배포 실패'
                    deployEnv = '운영'
                    deployType = 'AWS'
                    deployInfo = '운영 서버에 배포가 실패했습니다.'
                }
                
                mattermostSend color: 'danger', 
                    message: """
❌ 배포 실패: ${env.BRANCH_NAME} #${env.BUILD_NUMBER}
👤 작성자: ${env.AUTHOR_NAME} ${env.AUTHOR_EMAIL ? '(' + env.AUTHOR_EMAIL + ')' : ''}
🌐 환경: ${deployEnv} (${deployType})
⚠️ 상세 정보: ${deployInfo}
🔗 빌드 링크: ${env.BUILD_URL}
""",
                    channel: 's306-alarm',
                    endpoint: 'https://meeting.ssafy.com/hooks/7qa9fbgsbtb3fyak3sao9n887e'
            }
        }
        always {
            echo '배포 파이프라인 종료'
            cleanWs()
        }
    }
}
